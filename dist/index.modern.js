import{useOpenCv as e,OpenCvProvider as t}from"opencv-react";import r,{useCallback as n,useRef as o,useEffect as i,useState as a,useImperativeHandle as c,Fragment as l}from"react";import u from"react-draggable";function h(){return(h=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}var d=function(e,t,r){return{width:e,height:e,backgroundColor:t,border:r,borderRadius:"100%",position:"absolute",zIndex:1001}},s=function(e){var t=e.cropPoints,o=e.pointArea,i=e.defaultPosition,a=e.pointSize,c=e.pointBgColor,l=void 0===c?"transparent":c,s=e.pointBorder,f=void 0===s?"4px solid #3cabe2":s,p=e.onStop,m=e.onDrag,v=e.bounds,g=n(function(e,t){m(h({},t,{x:t.x+a/2,y:t.y+a/2}),o)},[m]),y=n(function(e,r){p(h({},r,{x:r.x+a/2,y:r.y+a/2}),o,t)},[m,t]);return r.createElement(u,{bounds:v,defaultPosition:i,position:{x:t[o].x-a/2,y:t[o].y-a/2},onDrag:g,onStop:y},r.createElement("div",{style:d(a,l,f)}))},f=["previewDims"],p=function(e){var t=e.previewDims,n=function(e,t){if(null==e)return{};var r,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)t.indexOf(r=i[n])>=0||(o[r]=e[r]);return o}(e,f);return r.createElement(r.Fragment,null,r.createElement(s,Object.assign({pointArea:"left-top",defaultPosition:{x:0,y:0}},n)),r.createElement(s,Object.assign({pointArea:"right-top",defaultPosition:{x:t.width,y:0}},n)),r.createElement(s,Object.assign({pointArea:"right-bottom",defaultPosition:{x:0,y:t.height}},n)),r.createElement(s,Object.assign({pointArea:"left-bottom",defaultPosition:{x:t.width,y:t.height}},n)))},m=function(e){var t=e.cropPoints,a=e.previewDims,c=e.lineWidth,l=void 0===c?3:c,u=e.lineColor,h=void 0===u?"#3cabe2":u,d=e.pointSize,s=o(null),f=n(function(){var e,t=null===(e=s.current)||void 0===e?void 0:e.getContext("2d",{alpha:!0,willReadFrequently:!0});null==t||t.clearRect(0,0,a.width,a.height)},[s.current,a]),p=n(function(){return["left-top","right-top","right-bottom","left-bottom"].reduce(function(e,r){return[].concat(e,[t[r]])},[])},[t]),m=n(function(e){var t,r=e[0],n=e[1],o=e[2],i=e[3],a=null===(t=s.current)||void 0===t?void 0:t.getContext("2d",{alpha:!0,willReadFrequently:!0});a&&(a.lineWidth=l,a.strokeStyle=h,a.beginPath(),a.moveTo(r.x+d/2,r.y),a.lineTo(n.x-d/2,n.y),a.moveTo(n.x,n.y+d/2),a.lineTo(o.x,o.y-d/2),a.moveTo(o.x-d/2,o.y),a.lineTo(i.x+d/2,i.y),a.moveTo(i.x,i.y-d/2),a.lineTo(r.x,r.y+d/2),a.closePath(),a.stroke())},[s.current]);return i(function(){if(t&&s.current){f();var e=p();m(e)}},[t,s.current]),r.createElement("canvas",{ref:s,style:{position:"absolute",zIndex:5},width:a.width,height:a.height})},v=function(e){return{width:e.width,height:e.height}},g=1,y=function(t){var u=t.image,d=t.onDragStop,s=t.onChange,f=t.cropperRef,y=t.pointSize,w=void 0===y?30:y,x=t.lineWidth,b=t.pointBgColor,E=t.pointBorder,R=t.lineColor,P=t.maxWidth,C=t.maxHeight,A=e(),S=A.loaded,T=A.cv,O=o(),B=o(null),_=o(null),z=a(),D=z[0],F=z[1],M=a(),j=M[0],I=M[1],H=a(!1),N=H[0],L=H[1],k=a("crop"),W=k[0],G=k[1],q=function(){if(O.current){var e=function(e,t,r,n){var o=e/t,i=r||window.innerWidth,a=n||window.innerHeight,c={width:i,height:Math.round(i/o),ratio:o};return c.height>a&&(c.height=a,c.width=Math.round(a*o)),c}(O.current.width,O.current.height,P,C);F(e),B.current&&(B.current.width=e.width,B.current.height=e.height,g=e.width/O.current.width)}};c(f,function(){return{backToCrop:function(){G("crop")},done:function(e){void 0===e&&(e={});try{return Promise.resolve(new Promise(function(t,r){L(!0),T&&O.current&&j?(function(e,t,r,n,o){var i,a,c=e.imread(t),l=r["right-bottom"],u=r["left-bottom"],h=r["right-top"],d=r["left-top"],s=[d,h,l,u].map(function(e){return[e.x/n,e.y/n]}),f=Math.max(l.x-u.x,h.x-d.x)/n,p=Math.max(u.y-d.y,l.y-h.y)/n,m=[[0,0],[f-1,0],[f-1,p-1],[0,p-1]],v=e.matFromArray(4,1,e.CV_32FC2,(i=[]).concat.apply(i,s)),g=e.matFromArray(4,1,e.CV_32FC2,(a=[]).concat.apply(a,m)),y=e.getPerspectiveTransform(v,g),w=new e.Size(f,p);e.warpPerspective(c,c,y,w,e.INTER_LINEAR,e.BORDER_CONSTANT,new e.Scalar),e.imshow(t,c),c.delete(),v.delete(),g.delete(),y.delete(),o()}(T,O.current,j,g,q),function(e,t,r){try{var n=h({blur:!1,th:!0,thMode:e.ADAPTIVE_THRESH_MEAN_C,thMeanCorrection:15,thBlockSize:25,thMax:255,grayScale:!0},r),o=e.imread(t);if(n.grayScale&&e.cvtColor(o,o,e.COLOR_RGBA2GRAY,0),n.blur){var i=new e.Size(5,5);e.GaussianBlur(o,o,i,0,0,e.BORDER_DEFAULT)}n.th&&(n.grayScale?e.adaptiveThreshold(o,o,n.thMax,n.thMode,e.THRESH_BINARY,n.thBlockSize,n.thMeanCorrection):(o.convertTo(o,-1,1,60),e.threshold(o,o,170,255,e.THRESH_BINARY))),e.imshow(t,o),Promise.resolve()}catch(e){return Promise.reject(e)}}(T,O.current,e.filterCvParams),e.preview&&G("preview"),O.current.toBlob(function(e){e?t(e):r(new Error("Failed to create blob")),L(!1)},u instanceof File?u.type:"image/png")):r(new Error("OpenCV not loaded or canvas not initialized"))}))}catch(e){return Promise.reject(e)}}}});var V=function(){if(T&&O.current&&B.current){var e=T.imread(O.current),t=new T.Mat,r=new T.Size(0,0);T.resize(e,t,r,g,g,T.INTER_AREA),T.imshow(B.current,t),e.delete(),t.delete()}};i(function(){"preview"===W&&V()},[W]);var Y=function(){if(_.current){var e=_.current.getContext("2d",{alpha:!0,willReadFrequently:!0});null==e||e.clearRect(0,0,_.current.width,_.current.height)}};i(function(){s&&s(h({},j,{loading:N}))},[j,N]),i(function(){u&&B.current&&S&&"crop"===W?function(){try{return Promise.resolve((e=u,e instanceof File?new Promise(function(t,r){var n=new FileReader;n.onload=function(e){t(n.result)},n.onerror=function(e){r(e)},n.readAsDataURL(e)}):Promise.resolve("string"==typeof e?e:null))).then(function(e){if(e)return Promise.resolve(function(e){try{return Promise.resolve(new Promise(function(t){var r,n,o=document.createElement("img");o.onload=function(){try{O.current=document.createElement("canvas"),O.current.width=o.width,O.current.height=o.height;var e=O.current.getContext("2d",{alpha:!0,willReadFrequently:!0});return null==e||e.drawImage(o,0,0),q(),t(),Promise.resolve()}catch(e){return Promise.reject(e)}},r=window.location,null===(n=e.match(/^(\w+:)\/\/([^:/?#]*):?(\d*)/i))||n[1]===r.protocol&&n[2]===r.hostname&&n[3]===r.port||(o.crossOrigin="anonymous"),o.src=e}))}catch(e){return Promise.reject(e)}}(e)).then(function(){V(),function(){if(T&&O.current){var e=T.imread(O.current),t=new T.Size(5,5);T.cvtColor(e,e,T.COLOR_RGBA2GRAY,0),T.GaussianBlur(e,e,t,0,0,T.BORDER_DEFAULT),T.Canny(e,e,75,200),T.threshold(e,e,120,200,T.THRESH_BINARY);var r=new T.MatVector,n=new T.Mat;T.findContours(e,r,n,T.RETR_CCOMP,T.CHAIN_APPROX_SIMPLE);var o=T.boundingRect(e);e.delete(),n.delete(),r.delete(),Object.keys(o).forEach(function(e){o[e]*=g}),I({"left-top":{x:o.x,y:o.y},"right-top":{x:o.x+o.width,y:o.y},"right-bottom":{x:o.x+o.width,y:o.y+o.height},"left-bottom":{x:o.x,y:o.y+o.height}})}}(),L(!1)})})}catch(e){return Promise.reject(e)}var e}():L(!0)},[u,B.current,S,W]);var U=n(function(e,t){var r,n=e.x,o=e.y,i=null===(r=_.current)||void 0===r?void 0:r.getContext("2d",{alpha:!0,willReadFrequently:!0});Y(),B.current&&(null==i||i.drawImage(B.current,n-(w-10),o-(w-10),w+5,w+5,n+10,o-90,w+20,w+20),I(function(e){var r;return h({},e,((r={})[t]={x:n,y:o},r))}))},[]),X=n(function(e,t,r){var n,o=e.x,i=e.y;Y(),I(function(e){var r;return h({},e,((r={})[t]={x:o,y:i},r))}),d&&d(h({},r,((n={})[t]={x:o,y:i},n)))},[]);return r.createElement("div",{style:h({position:"relative"},D&&v(D))},D&&"crop"===W&&j&&B.current&&r.createElement(l,null,r.createElement(p,{pointSize:w,pointBgColor:b,pointBorder:E,cropPoints:j,previewDims:D,onDrag:U,onStop:X,bounds:{left:B.current.offsetLeft-w/2,top:B.current.offsetTop-w/2,right:B.current.offsetLeft-w/2+B.current.offsetWidth,bottom:B.current.offsetTop-w/2+B.current.offsetHeight}}),r.createElement(m,{previewDims:D,cropPoints:j,lineWidth:x,lineColor:R,pointSize:w}),r.createElement("canvas",{style:{position:"absolute",zIndex:5,pointerEvents:"none"},width:D.width,height:D.height,ref:_})),r.createElement("canvas",{style:{zIndex:5,pointerEvents:"none"},ref:B}))},w=r.forwardRef(function(e,n){return e.image?r.createElement(t,{openCvPath:e.openCvPath},r.createElement(y,Object.assign({},e,{cropperRef:n}))):null});export default w;
//# sourceMappingURL=index.modern.js.map
