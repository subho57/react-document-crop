import{useOpenCv as t,OpenCvProvider as e}from"opencv-react-ts";import o,{useCallback as r,useRef as n,useEffect as i,useState as a,useImperativeHandle as l,Fragment as c}from"react";import h from"react-draggable";function u(){return(u=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(t[r]=o[r])}return t}).apply(this,arguments)}var f=function(t,e,o){return{width:t,height:t,backgroundColor:e,border:o,borderRadius:"100%",position:"absolute",zIndex:1001,cursor:"pointer"}},d=function(t,e,o,r){return{width:r?t/2:t,height:r?t:t/2,backgroundColor:e,border:o,marginTop:r?void 0:t/4,marginLeft:r?t/4:void 0,position:"absolute",zIndex:1001,cursor:"pointer"}},s=function(t){var e=t.cropPoints,n=t.pointArea,i=t.defaultPosition,a=t.pointSize,l=t.pointBgColor,c=t.pointBorder,s=t.onStop,p=t.onDrag,m=t.bounds,g=r(function(t,o){p(u({},o,{x:o.x+a/2,y:o.y+a/2}),n,e)},[p]),y=r(function(t,o){s(u({},o,{x:o.x+a/2,y:o.y+a/2}),n,e)},[p,e]);return o.createElement(h,{bounds:m,defaultPosition:i,position:{x:e[n].x-a/2,y:e[n].y-a/2},onDrag:g,onStop:y,axis:"top"===n||"bottom"===n?"y":"left"===n||"right"===n?"x":"both"},o.createElement("div",{style:["top","bottom","left","right"].includes(n)?d(a,l,c,"left"===n||"right"===n):f(a,l,c)}))},p=["previewDims"],m=function(t){var e=t.previewDims,r=function(t,e){if(null==t)return{};var o,r,n={},i=Object.keys(t);for(r=0;r<i.length;r++)e.indexOf(o=i[r])>=0||(n[o]=t[o]);return n}(t,p);return o.createElement(o.Fragment,null,o.createElement(s,Object.assign({pointArea:"top",defaultPosition:{x:0,y:0}},r)),o.createElement(s,Object.assign({pointArea:"right",defaultPosition:{x:e.width,y:0}},r)),o.createElement(s,Object.assign({pointArea:"bottom",defaultPosition:{x:0,y:e.height}},r)),o.createElement(s,Object.assign({pointArea:"left",defaultPosition:{x:e.width,y:e.height}},r)),o.createElement(s,Object.assign({pointArea:"left-top",defaultPosition:{x:0,y:0}},r)),o.createElement(s,Object.assign({pointArea:"right-top",defaultPosition:{x:e.width,y:0}},r)),o.createElement(s,Object.assign({pointArea:"right-bottom",defaultPosition:{x:0,y:e.height}},r)),o.createElement(s,Object.assign({pointArea:"left-bottom",defaultPosition:{x:e.width,y:e.height}},r)))},g=function(t){var e=t.cropPoints,a=t.previewDims,l=t.lineWidth,c=t.lineColor,h=t.pointSize,u=n(null),f=r(function(){var t,e=null===(t=u.current)||void 0===t?void 0:t.getContext("2d",{alpha:!0,willReadFrequently:!0});null==e||e.clearRect(0,0,a.width,a.height)},[u.current,a]),d=r(function(){var t,o=e["left-top"],r=e["right-top"],n=e["right-bottom"],i=e["left-bottom"],a=e.left,f=e.top,d=e.right,s=e.bottom,p=null===(t=u.current)||void 0===t?void 0:t.getContext("2d",{alpha:!0,willReadFrequently:!0});if(p){p.lineWidth=l,p.strokeStyle=c;var m=h/2;p.beginPath(),p.moveTo(o.x+m,o.y),p.lineTo(r.x-m,r.y),p.moveTo(r.x,r.y+m),p.lineTo(n.x,n.y-m),p.moveTo(n.x-m,n.y),p.lineTo(i.x+m,i.y),p.moveTo(i.x,i.y-m),p.lineTo(o.x,o.y+m),p.closePath(),p.stroke(),p.clearRect(f.x-m,f.y-m,h,h),p.clearRect(d.x-m,d.y-m,h,h),p.clearRect(s.x-m,s.y-m,h,h),p.clearRect(a.x-m,a.y-m,h,h)}},[e,u.current]);return i(function(){e&&u.current&&(f(),d())},[e,u.current]),o.createElement("canvas",{ref:u,style:{position:"absolute",zIndex:5},width:a.width,height:a.height})};function y(t,e){return{x:(t.x+e.x)/2,y:(t.y+e.y)/2}}var x=function(t){return{width:t.width,height:t.height}},v=0,b=function(e){var h=e.image,f=e.onDragStop,d=e.onChange,s=e.cropperRef,p=e.maxWidth,b=e.maxHeight,w=e.lineWidth,E=void 0===w?3:w,P=e.pointSize,R=void 0===P?30:P,C=e.magnification,T=void 0===C?3:C,O=e.displayGrid,A=void 0===O||O,S=e.autoCrop,_=void 0===S||S,I=e.lineColor,B=void 0===I?"#3cabe2":I,j=e.pointBgColor,z=void 0===j?"transparent":j,M=e.pointBorder,D=void 0===M?"4px solid #3cabe2":M,F=e.offset,k=void 0===F?{x:60,y:60}:F,H=t(),L=H.loaded,N=H.cv,W=n(),G=n(null),q=n(null),V=a(),Y=V[0],U=V[1],K=a(),X=K[0],J=K[1],Q=a(!1),Z=Q[0],$=Q[1],tt=a("crop"),et=tt[0],ot=tt[1],rt=function(){if(W.current){var t=function(t,e,o,r){var n=t/e,i=o||window.innerWidth,a=r||window.innerHeight,l={width:i,height:Math.round(i/n),ratio:n};return l.height>a&&(l.height=a,l.width=Math.round(a*n)),l}(W.current.width,W.current.height,p,b);U(t),G.current&&(G.current.width=t.width,G.current.height=t.height,v=t.width/W.current.width)}},nt=function(t){if(N&&W.current&&G.current){var e=t||N.imread(W.current),o=new N.Mat,r=new N.Size(0,0);N.resize(e,o,r,v,v,N.INTER_AREA),N.imshow(G.current,o),e.delete(),o.delete()}},it=function(t){if(void 0===t&&(t=_),N&&W.current){var e=N.imread(W.current);if(N.cvtColor(e,e,N.COLOR_RGBA2GRAY,0),t){var o=new N.Size(5,5);N.GaussianBlur(e,e,o,0,0,N.BORDER_DEFAULT),N.Canny(e,e,75,200),N.threshold(e,e,120,200,N.THRESH_BINARY);var r=new N.MatVector,n=new N.Mat;N.findContours(e,r,n,N.RETR_CCOMP,N.CHAIN_APPROX_SIMPLE),n.delete(),r.delete()}var i=N.boundingRect(e);e.delete(),Object.keys(i).forEach(function(t){i[t]*=v}),J({top:{x:i.x+i.width/2,y:i.y},bottom:{x:i.x+i.width/2,y:i.y+i.height},left:{x:i.x,y:i.y+i.height/2},right:{x:i.x+i.width,y:i.y+i.height/2},"left-top":{x:i.x,y:i.y},"right-top":{x:i.x+i.width,y:i.y},"right-bottom":{x:i.x+i.width,y:i.y+i.height},"left-bottom":{x:i.x,y:i.y+i.height}})}};l(s,function(){return{backToCrop:function(){ot("crop")},mirror:function(t){N&&W.current&&(function(t,e,o){var r=t.imread(e);t.flip(r,r,o?1:0),t.imshow(e,r),r.delete()}(N,W.current,t),rt(),nt(),it())},rotate:function(t){N&&W.current&&(function(t,e,o){var r=t.imread(e),n={90:t.ROTATE_90_CLOCKWISE,180:t.ROTATE_180,270:t.ROTATE_90_COUNTERCLOCKWISE};if(void 0!==n[o]&&(t.rotate(r,r,n[o]),90===o||270===o)){var i=e.width;e.width=e.height,e.height=i}t.imshow(e,r),r.delete()}(N,W.current,t),rt(),nt(),it())},reset:function(){N&&W.current&&(rt(),nt(),it(!1))},done:function(t){void 0===t&&(t={});try{return Promise.resolve(new Promise(function(e,o){$(!0),N&&W.current&&X?(function(t,e,o,r,n){var i,a,l=t.imread(e),c=o["right-bottom"],h=o["left-bottom"],u=o["right-top"],f=o["left-top"],d=[f,u,c,h].map(function(t){return[t.x/r,t.y/r]}),s=Math.max(c.x-h.x,u.x-f.x)/r,p=Math.max(h.y-f.y,c.y-u.y)/r,m=[[0,0],[s-1,0],[s-1,p-1],[0,p-1]],g=t.matFromArray(4,1,t.CV_32FC2,(i=[]).concat.apply(i,d)),y=t.matFromArray(4,1,t.CV_32FC2,(a=[]).concat.apply(a,m)),x=t.getPerspectiveTransform(g,y),v=new t.Size(s,p);t.warpPerspective(l,l,x,v,t.INTER_LINEAR,t.BORDER_CONSTANT,new t.Scalar),t.imshow(e,l),l.delete(),g.delete(),y.delete(),x.delete(),n()}(N,W.current,X,v,rt),function(t,e,o){var r=u({blur:!1,th:!1,thMode:t.ADAPTIVE_THRESH_MEAN_C,thMeanCorrection:15,thBlockSize:25,thMax:255,grayScale:!1},o),n=t.imread(e);if(r.grayScale&&t.cvtColor(n,n,t.COLOR_RGBA2GRAY,0),r.blur){var i=new t.Size(5,5);t.GaussianBlur(n,n,i,0,0,t.BORDER_DEFAULT)}r.th&&(r.grayScale?t.adaptiveThreshold(n,n,r.thMax,r.thMode,t.THRESH_BINARY,r.thBlockSize,r.thMeanCorrection):(n.convertTo(n,-1,1,60),t.threshold(n,n,170,255,t.THRESH_BINARY))),t.imshow(e,n),n.delete()}(N,W.current,t.filterCvParams),t.preview&&ot("preview"),W.current.toBlob(function(t){t?e(t):o(new Error("Failed to create blob")),$(!1)},h instanceof File?h.type:"image/png")):o(new Error("OpenCV not loaded or canvas not initialized"))}))}catch(t){return Promise.reject(t)}}}}),i(function(){"preview"===et&&nt()},[et]);var at=function(){if(q.current){var t=q.current.getContext("2d",{alpha:!0,willReadFrequently:!0});null==t||t.clearRect(0,0,q.current.width,q.current.height)}};i(function(){null==d||d(u({},X,{loading:Z}))},[X,Z]),i(function(){h&&G.current&&L&&"crop"===et?function(){try{return Promise.resolve((t=h,t instanceof File?new Promise(function(e,o){var r=new FileReader;r.onload=function(t){e(r.result)},r.onerror=function(t){o(t)},r.readAsDataURL(t)}):Promise.resolve("string"==typeof t?t:null))).then(function(t){if(t)return Promise.resolve(function(t){try{return Promise.resolve(new Promise(function(e){var o,r,n=document.createElement("img");n.onload=function(){try{W.current=document.createElement("canvas"),W.current.width=n.width,W.current.height=n.height;var t=W.current.getContext("2d",{alpha:!0,willReadFrequently:!0});return null==t||t.drawImage(n,0,0),rt(),e(),Promise.resolve()}catch(t){return Promise.reject(t)}},o=window.location,null===(r=t.match(/^(\w+:)\/\/([^:/?#]*):?(\d*)/i))||r[1]===o.protocol&&r[2]===o.hostname&&r[3]===o.port||(n.crossOrigin="anonymous"),n.src=t}))}catch(t){return Promise.reject(t)}}(t)).then(function(){nt(),it(),$(!1)})})}catch(t){return Promise.reject(t)}var t}():$(!0)},[h,G.current,L,et]);var lt=function(t,e,o){var r=t.x,n=t.y;if(e.includes("-"))o[e]={x:r,y:n},e.includes("left")&&(o.left=y(o["left-top"],o["left-bottom"])),e.includes("right")&&(o.right=y(o["right-top"],o["right-bottom"])),e.includes("top")&&(o.top=y(o["left-top"],o["right-top"])),e.includes("bottom")&&(o.bottom=y(o["left-bottom"],o["right-bottom"]));else{var i=r-o[e].x,a=n-o[e].y;"left"===e?(o["left-top"]={x:r,y:o["left-top"].y+a},o["left-bottom"]={x:r,y:o["left-bottom"].y+a},o.left=y(o["left-top"],o["left-bottom"]),o.top=y(o["left-top"],o["right-top"]),o.bottom=y(o["left-bottom"],o["right-bottom"])):"right"===e?(o["right-top"]={x:r,y:o["right-top"].y+a},o["right-bottom"]={x:r,y:o["right-bottom"].y+a},o.right=y(o["right-top"],o["right-bottom"]),o.top=y(o["left-top"],o["right-top"]),o.bottom=y(o["left-bottom"],o["right-bottom"])):"top"===e?(o["left-top"]={x:o["left-top"].x+i,y:n},o["right-top"]={x:o["right-top"].x+i,y:n},o.top=y(o["left-top"],o["right-top"]),o.left=y(o["left-top"],o["left-bottom"]),o.right=y(o["right-top"],o["right-bottom"])):"bottom"===e&&(o["left-bottom"]={x:o["left-bottom"].x+i,y:n},o["right-bottom"]={x:o["right-bottom"].x+i,y:n},o.bottom=y(o["left-bottom"],o["right-bottom"]),o.left=y(o["left-top"],o["left-bottom"]),o.right=y(o["right-top"],o["right-bottom"]))}J(function(t){return u({},t,o)})},ct=r(function(t,e,o){var r=t.x,n=t.y;if(at(),e.includes("-")){var i,a=null===(i=q.current)||void 0===i?void 0:i.getContext("2d",{alpha:!0,willReadFrequently:!0});if(!a)return;if(a.lineWidth=1.5*E,a.strokeStyle=B,!G.current)return;var l=R/2,c=u({},k);"left-top"===e?(c.x=+c.x,c.y=+c.y):"right-top"===e?(c.x=-c.x,c.y=+c.y):"left-bottom"===e?(c.x=+c.x,c.y=-c.y):"right-bottom"===e&&(c.x=-c.x,c.y=-c.y),a.save(),a.beginPath(),a.arc(r+c.x,n+c.y,l*T,0,2*Math.PI),a.closePath(),a.stroke(),a.clip(),a.drawImage(G.current,r-l,n-l,R,R,r+c.x-l*T,n+c.y-l*T,R*T,R*T),a.beginPath(),a.arc(0,0,l*T,0,2*Math.PI,!0),a.clip(),a.closePath(),a.restore(),A&&(a.beginPath(),a.lineWidth=E,a.moveTo(r+c.x-l*T,n+c.y),a.lineTo(r+c.x+l*T,n+c.y),a.moveTo(r+c.x,n+c.y-l*T),a.lineTo(r+c.x,n+c.y+l*T),a.closePath(),a.stroke())}lt(t,e,o)},[]),ht=r(function(t,e,o){var r,n=t.x,i=t.y;at(),lt(t,e,o),null==f||f(u({},o,((r={})[e]={x:n,y:i},r)))},[]);return o.createElement("div",{style:u({position:"relative"},Y&&x(Y))},Y&&"crop"===et&&X&&G.current&&o.createElement(c,null,o.createElement(m,{pointSize:R,pointBgColor:z,pointBorder:D,cropPoints:X,previewDims:Y,onDrag:ct,onStop:ht,bounds:{left:G.current.offsetLeft-R/2,top:G.current.offsetTop-R/2,right:G.current.offsetLeft-R/2+G.current.offsetWidth,bottom:G.current.offsetTop-R/2+G.current.offsetHeight}}),o.createElement(g,{displayGrid:A,previewDims:Y,cropPoints:X,lineWidth:E,lineColor:B,pointSize:R}),o.createElement("canvas",{style:{position:"absolute",zIndex:1002,pointerEvents:"none"},width:Y.width,height:Y.height,ref:q})),o.createElement("canvas",{style:{zIndex:5,pointerEvents:"none"},ref:G}))},w=o.forwardRef(function(t,r){return t.image?o.createElement(e,{openCvPath:t.openCvPath},o.createElement(b,Object.assign({},t,{cropperRef:r}))):null});export default w;
//# sourceMappingURL=index.modern.js.map
