function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var e=require("opencv-react-ts"),o=require("react"),r=t(o),n=t(require("react-draggable"));function i(){return(i=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(t[r]=o[r])}return t}).apply(this,arguments)}var a=function(t,e,o){return{width:t,height:t,backgroundColor:e,border:o,borderRadius:"100%",position:"absolute",zIndex:1001,cursor:"pointer"}},l=function(t,e,o,r){return{width:r?t/2:t,height:r?t:t/2,backgroundColor:e,border:o,marginTop:r?void 0:t/4,marginLeft:r?t/4:void 0,position:"absolute",zIndex:1001,cursor:"pointer"}},c=function(t){var e=t.cropPoints,c=t.pointArea,u=t.defaultPosition,h=t.pointSize,f=t.pointBgColor,s=t.pointBorder,d=t.onStop,p=t.onDrag,g=t.bounds,m=o.useCallback(function(t,o){p(i({},o,{x:o.x+h/2,y:o.y+h/2}),c,e)},[p]),y=o.useCallback(function(t,o){d(i({},o,{x:o.x+h/2,y:o.y+h/2}),c,e)},[p,e]);return r.createElement(n,{bounds:g,defaultPosition:u,position:{x:e[c].x-h/2,y:e[c].y-h/2},onDrag:m,onStop:y,axis:"top"===c||"bottom"===c?"y":"left"===c||"right"===c?"x":"both"},r.createElement("div",{style:["top","bottom","left","right"].includes(c)?l(h,f,s,"left"===c||"right"===c):a(h,f,s)}))},u=["previewDims"],h=function(t){var e=t.previewDims,o=function(t,e){if(null==t)return{};var o,r,n={},i=Object.keys(t);for(r=0;r<i.length;r++)e.indexOf(o=i[r])>=0||(n[o]=t[o]);return n}(t,u);return r.createElement(r.Fragment,null,r.createElement(c,Object.assign({pointArea:"top",defaultPosition:{x:0,y:0}},o)),r.createElement(c,Object.assign({pointArea:"right",defaultPosition:{x:e.width,y:0}},o)),r.createElement(c,Object.assign({pointArea:"bottom",defaultPosition:{x:0,y:e.height}},o)),r.createElement(c,Object.assign({pointArea:"left",defaultPosition:{x:e.width,y:e.height}},o)),r.createElement(c,Object.assign({pointArea:"left-top",defaultPosition:{x:0,y:0}},o)),r.createElement(c,Object.assign({pointArea:"right-top",defaultPosition:{x:e.width,y:0}},o)),r.createElement(c,Object.assign({pointArea:"right-bottom",defaultPosition:{x:0,y:e.height}},o)),r.createElement(c,Object.assign({pointArea:"left-bottom",defaultPosition:{x:e.width,y:e.height}},o)))},f=function(t){var e=t.cropPoints,n=t.previewDims,i=t.lineWidth,a=t.lineColor,l=t.pointSize,c=o.useRef(null),u=o.useCallback(function(){var t,e=null===(t=c.current)||void 0===t?void 0:t.getContext("2d",{alpha:!0,willReadFrequently:!0});null==e||e.clearRect(0,0,n.width,n.height)},[c.current,n]),h=o.useCallback(function(){var t,o=e["left-top"],r=e["right-top"],n=e["right-bottom"],u=e["left-bottom"],h=e.left,f=e.top,s=e.right,d=e.bottom,p=null===(t=c.current)||void 0===t?void 0:t.getContext("2d",{alpha:!0,willReadFrequently:!0});if(p){p.lineWidth=i,p.strokeStyle=a;var g=l/2;p.beginPath(),p.moveTo(o.x+g,o.y),p.lineTo(r.x-g,r.y),p.moveTo(r.x,r.y+g),p.lineTo(n.x,n.y-g),p.moveTo(n.x-g,n.y),p.lineTo(u.x+g,u.y),p.moveTo(u.x,u.y-g),p.lineTo(o.x,o.y+g),p.closePath(),p.stroke(),p.clearRect(f.x-g,f.y-g,l,l),p.clearRect(s.x-g,s.y-g,l,l),p.clearRect(d.x-g,d.y-g,l,l),p.clearRect(h.x-g,h.y-g,l,l)}},[e,c.current]);return o.useEffect(function(){e&&c.current&&(u(),h())},[e,c.current]),r.createElement("canvas",{ref:c,style:{position:"absolute",zIndex:5},width:n.width,height:n.height})};function s(t,e){return{x:(t.x+e.x)/2,y:(t.y+e.y)/2}}var d=function(t){return{width:t.width,height:t.height}},p=0,g=function(t){var n=t.image,a=t.onDragStop,l=t.onChange,c=t.cropperRef,u=t.maxWidth,g=t.maxHeight,m=t.lineWidth,y=void 0===m?3:m,v=t.pointSize,x=void 0===v?30:v,b=t.magnification,w=void 0===b?3:b,E=t.displayGrid,R=void 0===E||E,C=t.autoCrop,P=void 0===C||C,T=t.lineColor,O=void 0===T?"#3cabe2":T,A=t.pointBgColor,S=void 0===A?"transparent":A,_=t.pointBorder,I=void 0===_?"4px solid #3cabe2":_,j=t.offset,B=void 0===j?{x:60,y:60}:j,k=e.useOpenCv(),z=k.loaded,M=k.cv,F=o.useRef(),D=o.useRef(null),H=o.useRef(null),L=o.useState(),N=L[0],W=L[1],q=o.useState(),G=q[0],V=q[1],Y=o.useState(!1),U=Y[0],K=Y[1],X=o.useState("crop"),J=X[0],Q=X[1],Z=function(){if(F.current){var t=function(t,e,o,r){var n=t/e,i=o||window.innerWidth,a=r||window.innerHeight,l={width:i,height:Math.round(i/n),ratio:n};return l.height>a&&(l.height=a,l.width=Math.round(a*n)),l}(F.current.width,F.current.height,u,g);W(t),D.current&&(D.current.width=t.width,D.current.height=t.height,p=t.width/F.current.width)}},$=function(t){if(M&&F.current&&D.current){var e=t||M.imread(F.current),o=new M.Mat,r=new M.Size(0,0);M.resize(e,o,r,p,p,M.INTER_AREA),M.imshow(D.current,o),e.delete(),o.delete()}},tt=function(t){if(void 0===t&&(t=P),M&&F.current){var e=M.imread(F.current);if(M.cvtColor(e,e,M.COLOR_RGBA2GRAY,0),t){var o=new M.Size(5,5);M.GaussianBlur(e,e,o,0,0,M.BORDER_DEFAULT),M.Canny(e,e,75,200),M.threshold(e,e,120,200,M.THRESH_BINARY);var r=new M.MatVector,n=new M.Mat;M.findContours(e,r,n,M.RETR_CCOMP,M.CHAIN_APPROX_SIMPLE),n.delete(),r.delete()}var i=M.boundingRect(e);e.delete(),Object.keys(i).forEach(function(t){i[t]*=p}),V({top:{x:i.x+i.width/2,y:i.y},bottom:{x:i.x+i.width/2,y:i.y+i.height},left:{x:i.x,y:i.y+i.height/2},right:{x:i.x+i.width,y:i.y+i.height/2},"left-top":{x:i.x,y:i.y},"right-top":{x:i.x+i.width,y:i.y},"right-bottom":{x:i.x+i.width,y:i.y+i.height},"left-bottom":{x:i.x,y:i.y+i.height}})}};o.useImperativeHandle(c,function(){return{backToCrop:function(){Q("crop")},mirror:function(t){M&&F.current&&(function(t,e,o){var r=t.imread(e);t.flip(r,r,o?1:0),t.imshow(e,r),r.delete()}(M,F.current,t),Z(),$(),tt())},rotate:function(t){M&&F.current&&(function(t,e,o){var r=t.imread(e),n={90:t.ROTATE_90_CLOCKWISE,180:t.ROTATE_180,270:t.ROTATE_90_COUNTERCLOCKWISE};if(void 0!==n[o]&&(t.rotate(r,r,n[o]),90===o||270===o)){var i=e.width;e.width=e.height,e.height=i}t.imshow(e,r),r.delete()}(M,F.current,t),Z(),$(),tt())},reset:function(){M&&F.current&&(Z(),$(),tt(!1))},done:function(t){void 0===t&&(t={});try{return Promise.resolve(new Promise(function(e,o){K(!0),M&&F.current&&G?(function(t,e,o,r,n){var i,a,l=t.imread(e),c=o["right-bottom"],u=o["left-bottom"],h=o["right-top"],f=o["left-top"],s=[f,h,c,u].map(function(t){return[t.x/r,t.y/r]}),d=Math.max(c.x-u.x,h.x-f.x)/r,p=Math.max(u.y-f.y,c.y-h.y)/r,g=[[0,0],[d-1,0],[d-1,p-1],[0,p-1]],m=t.matFromArray(4,1,t.CV_32FC2,(i=[]).concat.apply(i,s)),y=t.matFromArray(4,1,t.CV_32FC2,(a=[]).concat.apply(a,g)),v=t.getPerspectiveTransform(m,y),x=new t.Size(d,p);t.warpPerspective(l,l,v,x,t.INTER_LINEAR,t.BORDER_CONSTANT,new t.Scalar),t.imshow(e,l),l.delete(),m.delete(),y.delete(),v.delete(),n()}(M,F.current,G,p,Z),function(t,e,o){var r=i({blur:!1,th:!1,thMode:t.ADAPTIVE_THRESH_MEAN_C,thMeanCorrection:15,thBlockSize:25,thMax:255,grayScale:!1},o),n=t.imread(e);if(r.grayScale&&t.cvtColor(n,n,t.COLOR_RGBA2GRAY,0),r.blur){var a=new t.Size(5,5);t.GaussianBlur(n,n,a,0,0,t.BORDER_DEFAULT)}r.th&&(r.grayScale?t.adaptiveThreshold(n,n,r.thMax,r.thMode,t.THRESH_BINARY,r.thBlockSize,r.thMeanCorrection):(n.convertTo(n,-1,1,60),t.threshold(n,n,170,255,t.THRESH_BINARY))),t.imshow(e,n),n.delete()}(M,F.current,t.filterCvParams),t.preview&&Q("preview"),F.current.toBlob(function(t){t?e(t):o(new Error("Failed to create blob")),K(!1)},n instanceof File?n.type:"image/png")):o(new Error("OpenCV not loaded or canvas not initialized"))}))}catch(t){return Promise.reject(t)}}}}),o.useEffect(function(){"preview"===J&&$()},[J]);var et=function(){if(H.current){var t=H.current.getContext("2d",{alpha:!0,willReadFrequently:!0});null==t||t.clearRect(0,0,H.current.width,H.current.height)}};o.useEffect(function(){null==l||l(i({},G,{loading:U}))},[G,U]),o.useEffect(function(){n&&D.current&&z&&"crop"===J?function(){try{return Promise.resolve((t=n,t instanceof File?new Promise(function(e,o){var r=new FileReader;r.onload=function(t){e(r.result)},r.onerror=function(t){o(t)},r.readAsDataURL(t)}):Promise.resolve("string"==typeof t?t:null))).then(function(t){if(t)return Promise.resolve(function(t){try{return Promise.resolve(new Promise(function(e){var o,r,n=document.createElement("img");n.onload=function(){try{F.current=document.createElement("canvas"),F.current.width=n.width,F.current.height=n.height;var t=F.current.getContext("2d",{alpha:!0,willReadFrequently:!0});return null==t||t.drawImage(n,0,0),Z(),e(),Promise.resolve()}catch(t){return Promise.reject(t)}},o=window.location,null===(r=t.match(/^(\w+:)\/\/([^:/?#]*):?(\d*)/i))||r[1]===o.protocol&&r[2]===o.hostname&&r[3]===o.port||(n.crossOrigin="anonymous"),n.src=t}))}catch(t){return Promise.reject(t)}}(t)).then(function(){$(),tt(),K(!1)})})}catch(t){return Promise.reject(t)}var t}():K(!0)},[n,D.current,z,J]);var ot=function(t,e,o){var r=t.x,n=t.y;if(e.includes("-"))o[e]={x:r,y:n},e.includes("left")&&(o.left=s(o["left-top"],o["left-bottom"])),e.includes("right")&&(o.right=s(o["right-top"],o["right-bottom"])),e.includes("top")&&(o.top=s(o["left-top"],o["right-top"])),e.includes("bottom")&&(o.bottom=s(o["left-bottom"],o["right-bottom"]));else{var a=r-o[e].x,l=n-o[e].y;"left"===e?(o["left-top"]={x:r,y:o["left-top"].y+l},o["left-bottom"]={x:r,y:o["left-bottom"].y+l},o.left=s(o["left-top"],o["left-bottom"]),o.top=s(o["left-top"],o["right-top"]),o.bottom=s(o["left-bottom"],o["right-bottom"])):"right"===e?(o["right-top"]={x:r,y:o["right-top"].y+l},o["right-bottom"]={x:r,y:o["right-bottom"].y+l},o.right=s(o["right-top"],o["right-bottom"]),o.top=s(o["left-top"],o["right-top"]),o.bottom=s(o["left-bottom"],o["right-bottom"])):"top"===e?(o["left-top"]={x:o["left-top"].x+a,y:n},o["right-top"]={x:o["right-top"].x+a,y:n},o.top=s(o["left-top"],o["right-top"]),o.left=s(o["left-top"],o["left-bottom"]),o.right=s(o["right-top"],o["right-bottom"])):"bottom"===e&&(o["left-bottom"]={x:o["left-bottom"].x+a,y:n},o["right-bottom"]={x:o["right-bottom"].x+a,y:n},o.bottom=s(o["left-bottom"],o["right-bottom"]),o.left=s(o["left-top"],o["left-bottom"]),o.right=s(o["right-top"],o["right-bottom"]))}V(function(t){return i({},t,o)})},rt=o.useCallback(function(t,e,o){var r=t.x,n=t.y;if(et(),e.includes("-")){var a,l=null===(a=H.current)||void 0===a?void 0:a.getContext("2d",{alpha:!0,willReadFrequently:!0});if(!l)return;if(l.lineWidth=1.5*y,l.strokeStyle=O,!D.current)return;var c=x/2,u=i({},B);"left-top"===e?(u.x=+u.x,u.y=+u.y):"right-top"===e?(u.x=-u.x,u.y=+u.y):"left-bottom"===e?(u.x=+u.x,u.y=-u.y):"right-bottom"===e&&(u.x=-u.x,u.y=-u.y),l.save(),l.beginPath(),l.arc(r+u.x,n+u.y,c*w,0,2*Math.PI),l.closePath(),l.stroke(),l.clip(),l.drawImage(D.current,r-c,n-c,x,x,r+u.x-c*w,n+u.y-c*w,x*w,x*w),l.beginPath(),l.arc(0,0,c*w,0,2*Math.PI,!0),l.clip(),l.closePath(),l.restore(),R&&(l.beginPath(),l.lineWidth=y,l.moveTo(r+u.x-c*w,n+u.y),l.lineTo(r+u.x+c*w,n+u.y),l.moveTo(r+u.x,n+u.y-c*w),l.lineTo(r+u.x,n+u.y+c*w),l.closePath(),l.stroke())}ot(t,e,o)},[]),nt=o.useCallback(function(t,e,o){var r,n=t.x,l=t.y;et(),ot(t,e,o),null==a||a(i({},o,((r={})[e]={x:n,y:l},r)))},[]);return r.createElement("div",{style:i({position:"relative"},N&&d(N))},N&&"crop"===J&&G&&D.current&&r.createElement(o.Fragment,null,r.createElement(h,{pointSize:x,pointBgColor:S,pointBorder:I,cropPoints:G,previewDims:N,onDrag:rt,onStop:nt,bounds:{left:D.current.offsetLeft-x/2,top:D.current.offsetTop-x/2,right:D.current.offsetLeft-x/2+D.current.offsetWidth,bottom:D.current.offsetTop-x/2+D.current.offsetHeight}}),r.createElement(f,{displayGrid:R,previewDims:N,cropPoints:G,lineWidth:y,lineColor:O,pointSize:x}),r.createElement("canvas",{style:{position:"absolute",zIndex:1002,pointerEvents:"none"},width:N.width,height:N.height,ref:H})),r.createElement("canvas",{style:{zIndex:5,pointerEvents:"none"},ref:D}))},m=r.forwardRef(function(t,o){return t.image?r.createElement(e.OpenCvProvider,{openCvPath:t.openCvPath},r.createElement(g,Object.assign({},t,{cropperRef:o}))):null});module.exports=m;
//# sourceMappingURL=index.js.map
