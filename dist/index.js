function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var e=require("opencv-react"),o=require("react"),r=t(o),n=t(require("react-draggable"));function i(){return(i=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(t[r]=o[r])}return t}).apply(this,arguments)}var l=function(t,e,o){return{width:t,height:t,backgroundColor:e,border:o,borderRadius:"100%",position:"absolute",zIndex:1001,cursor:"pointer"}},a=function(t,e,o,r){return{width:r?t/2:t,height:r?t:t/2,backgroundColor:e,border:o,marginTop:r?void 0:t/4,marginLeft:r?t/4:void 0,position:"absolute",zIndex:1001,cursor:"pointer"}},c=function(t){var e=t.cropPoints,c=t.pointArea,u=t.defaultPosition,h=t.pointSize,f=t.pointBgColor,s=void 0===f?"transparent":f,d=t.pointBorder,p=void 0===d?"4px solid #3cabe2":d,m=t.onStop,g=t.onDrag,y=t.bounds,v=o.useCallback(function(t,o){g(i({},o,{x:o.x+h/2,y:o.y+h/2}),c,e)},[g]),x=o.useCallback(function(t,o){m(i({},o,{x:o.x+h/2,y:o.y+h/2}),c,e)},[g,e]);return r.createElement(n,{bounds:y,defaultPosition:u,position:{x:e[c].x-h/2,y:e[c].y-h/2},onDrag:v,onStop:x,axis:"top"===c||"bottom"===c?"y":"left"===c||"right"===c?"x":"both"},r.createElement("div",{style:["top","bottom","left","right"].includes(c)?a(h,s,p,"left"===c||"right"===c):l(h,s,p)}))},u=["previewDims"],h=function(t){var e=t.previewDims,o=function(t,e){if(null==t)return{};var o,r,n={},i=Object.keys(t);for(r=0;r<i.length;r++)e.indexOf(o=i[r])>=0||(n[o]=t[o]);return n}(t,u);return r.createElement(r.Fragment,null,r.createElement(c,Object.assign({pointArea:"top",defaultPosition:{x:0,y:0}},o)),r.createElement(c,Object.assign({pointArea:"right",defaultPosition:{x:e.width,y:0}},o)),r.createElement(c,Object.assign({pointArea:"bottom",defaultPosition:{x:0,y:e.height}},o)),r.createElement(c,Object.assign({pointArea:"left",defaultPosition:{x:e.width,y:e.height}},o)),r.createElement(c,Object.assign({pointArea:"left-top",defaultPosition:{x:0,y:0}},o)),r.createElement(c,Object.assign({pointArea:"right-top",defaultPosition:{x:e.width,y:0}},o)),r.createElement(c,Object.assign({pointArea:"right-bottom",defaultPosition:{x:0,y:e.height}},o)),r.createElement(c,Object.assign({pointArea:"left-bottom",defaultPosition:{x:e.width,y:e.height}},o)))},f=function(t){var e=t.cropPoints,n=t.previewDims,i=t.lineWidth,l=void 0===i?3:i,a=t.lineColor,c=void 0===a?"#3cabe2":a,u=t.pointSize,h=t.displayGrid,f=void 0===h||h,s=o.useRef(null),d=o.useCallback(function(){var t,e=null===(t=s.current)||void 0===t?void 0:t.getContext("2d",{alpha:!0,willReadFrequently:!0});null==e||e.clearRect(0,0,n.width,n.height)},[s.current,n]),p=o.useCallback(function(){var t,o=e["left-top"],r=e["right-top"],n=e["right-bottom"],i=e["left-bottom"],a=e.left,h=e.top,d=e.right,p=e.bottom,m=null===(t=s.current)||void 0===t?void 0:t.getContext("2d",{alpha:!0,willReadFrequently:!0});if(m){m.lineWidth=l,m.strokeStyle=c;var g=u/2;m.beginPath(),m.moveTo(o.x+g,o.y),m.lineTo(r.x-g,r.y),m.moveTo(r.x,r.y+g),m.lineTo(n.x,n.y-g),m.moveTo(n.x-g,n.y),m.lineTo(i.x+g,i.y),m.moveTo(i.x,i.y-g),m.lineTo(o.x,o.y+g),m.closePath(),m.stroke(),m.clearRect(h.x-g,h.y-g,u,u),m.clearRect(d.x-g,d.y-g,u,u),m.clearRect(p.x-g,p.y-g,u,u),m.clearRect(a.x-g,a.y-g,u,u),f&&(m.lineWidth=l/2,m.beginPath(),m.moveTo(o.x-g,o.y),m.lineTo(o.x+g,o.y),m.moveTo(o.x,o.y+g),m.lineTo(o.x,o.y-g),m.moveTo(r.x-g,r.y),m.lineTo(r.x+g,r.y),m.moveTo(r.x,r.y+g),m.lineTo(r.x,r.y-g),m.moveTo(n.x-g,n.y),m.lineTo(n.x+g,n.y),m.moveTo(n.x,n.y+g),m.lineTo(n.x,n.y-g),m.moveTo(i.x-g,i.y),m.lineTo(i.x+g,i.y),m.moveTo(i.x,i.y+g),m.lineTo(i.x,i.y-g),m.closePath(),m.stroke())}},[e,s.current]);return o.useEffect(function(){e&&s.current&&(d(),p())},[e,s.current]),r.createElement("canvas",{ref:s,style:{position:"absolute",zIndex:5},width:n.width,height:n.height})};function s(t,e){return{x:(t.x+e.x)/2,y:(t.y+e.y)/2}}var d=function(t){return{width:t.width,height:t.height}},p=0,m=function(t){var n=t.image,l=t.onDragStop,a=t.onChange,c=t.cropperRef,u=t.pointSize,m=void 0===u?30:u,g=t.lineWidth,y=t.pointBgColor,v=t.pointBorder,x=t.lineColor,b=t.maxWidth,w=t.maxHeight,E=t.displayGrid,R=e.useOpenCv(),T=R.loaded,C=R.cv,P=o.useRef(),O=o.useRef(null),A=o.useRef(null),S=o.useState(),_=S[0],j=S[1],B=o.useState(),I=B[0],z=B[1],F=o.useState(!1),k=F[0],D=F[1],M=o.useState("crop"),H=M[0],L=M[1],N=function(){if(P.current){var t=function(t,e,o,r){var n=t/e,i=o||window.innerWidth,l=r||window.innerHeight,a={width:i,height:Math.round(i/n),ratio:n};return a.height>l&&(a.height=l,a.width=Math.round(l*n)),a}(P.current.width,P.current.height,b,w);j(t),O.current&&(O.current.width=t.width,O.current.height=t.height,p=t.width/P.current.width)}},W=function(t){if(C&&P.current&&O.current){var e=t||C.imread(P.current),o=new C.Mat,r=new C.Size(0,0);C.resize(e,o,r,p,p,C.INTER_AREA),C.imshow(O.current,o),e.delete(),o.delete()}},G=function(){if(C&&P.current){var t=C.imread(P.current),e=new C.Size(5,5);C.cvtColor(t,t,C.COLOR_RGBA2GRAY,0),C.GaussianBlur(t,t,e,0,0,C.BORDER_DEFAULT),C.Canny(t,t,75,200),C.threshold(t,t,120,200,C.THRESH_BINARY);var o=new C.MatVector,r=new C.Mat;C.findContours(t,o,r,C.RETR_CCOMP,C.CHAIN_APPROX_SIMPLE);var n=C.boundingRect(t);t.delete(),r.delete(),o.delete(),Object.keys(n).forEach(function(t){n[t]*=p}),z({top:{x:n.x+n.width/2,y:n.y},bottom:{x:n.x+n.width/2,y:n.y+n.height},left:{x:n.x,y:n.y+n.height/2},right:{x:n.x+n.width,y:n.y+n.height/2},"left-top":{x:n.x,y:n.y},"right-top":{x:n.x+n.width,y:n.y},"right-bottom":{x:n.x+n.width,y:n.y+n.height},"left-bottom":{x:n.x,y:n.y+n.height}})}};o.useImperativeHandle(c,function(){return{backToCrop:function(){L("crop")},mirror:function(t){C&&P.current&&(function(t,e,o){var r=t.imread(e);t.flip(r,r,o?1:0),t.imshow(e,r),r.delete()}(C,P.current,t),N(),W(),G())},rotate:function(t){C&&P.current&&(function(t,e,o){var r=t.imread(e),n={90:t.ROTATE_90_CLOCKWISE,180:t.ROTATE_180,270:t.ROTATE_90_COUNTERCLOCKWISE};if(void 0!==n[o]&&(t.rotate(r,r,n[o]),90===o||270===o)){var i=e.width;e.width=e.height,e.height=i}t.imshow(e,r),r.delete()}(C,P.current,t),N(),W(),G())},done:function(t){void 0===t&&(t={});try{return Promise.resolve(new Promise(function(e,o){D(!0),C&&P.current&&I?(function(t,e,o,r,n){var i,l,a=t.imread(e),c=o["right-bottom"],u=o["left-bottom"],h=o["right-top"],f=o["left-top"],s=[f,h,c,u].map(function(t){return[t.x/r,t.y/r]}),d=Math.max(c.x-u.x,h.x-f.x)/r,p=Math.max(u.y-f.y,c.y-h.y)/r,m=[[0,0],[d-1,0],[d-1,p-1],[0,p-1]],g=t.matFromArray(4,1,t.CV_32FC2,(i=[]).concat.apply(i,s)),y=t.matFromArray(4,1,t.CV_32FC2,(l=[]).concat.apply(l,m)),v=t.getPerspectiveTransform(g,y),x=new t.Size(d,p);t.warpPerspective(a,a,v,x,t.INTER_LINEAR,t.BORDER_CONSTANT,new t.Scalar),t.imshow(e,a),a.delete(),g.delete(),y.delete(),v.delete(),n()}(C,P.current,I,p,N),function(t,e,o){var r=i({blur:!1,th:!1,thMode:t.ADAPTIVE_THRESH_MEAN_C,thMeanCorrection:15,thBlockSize:25,thMax:255,grayScale:!1},o),n=t.imread(e);if(r.grayScale&&t.cvtColor(n,n,t.COLOR_RGBA2GRAY,0),r.blur){var l=new t.Size(5,5);t.GaussianBlur(n,n,l,0,0,t.BORDER_DEFAULT)}r.th&&(r.grayScale?t.adaptiveThreshold(n,n,r.thMax,r.thMode,t.THRESH_BINARY,r.thBlockSize,r.thMeanCorrection):(n.convertTo(n,-1,1,60),t.threshold(n,n,170,255,t.THRESH_BINARY))),t.imshow(e,n),n.delete()}(C,P.current,t.filterCvParams),t.preview&&L("preview"),P.current.toBlob(function(t){t?e(t):o(new Error("Failed to create blob")),D(!1)},n instanceof File?n.type:"image/png")):o(new Error("OpenCV not loaded or canvas not initialized"))}))}catch(t){return Promise.reject(t)}}}}),o.useEffect(function(){"preview"===H&&W()},[H]);var q=function(){if(A.current){var t=A.current.getContext("2d",{alpha:!0,willReadFrequently:!0});null==t||t.clearRect(0,0,A.current.width,A.current.height)}};o.useEffect(function(){null==a||a(i({},I,{loading:k}))},[I,k]),o.useEffect(function(){n&&O.current&&T&&"crop"===H?function(){try{return Promise.resolve((t=n,t instanceof File?new Promise(function(e,o){var r=new FileReader;r.onload=function(t){e(r.result)},r.onerror=function(t){o(t)},r.readAsDataURL(t)}):Promise.resolve("string"==typeof t?t:null))).then(function(t){if(t)return Promise.resolve(function(t){try{return Promise.resolve(new Promise(function(e){var o,r,n=document.createElement("img");n.onload=function(){try{P.current=document.createElement("canvas"),P.current.width=n.width,P.current.height=n.height;var t=P.current.getContext("2d",{alpha:!0,willReadFrequently:!0});return null==t||t.drawImage(n,0,0),N(),e(),Promise.resolve()}catch(t){return Promise.reject(t)}},o=window.location,null===(r=t.match(/^(\w+:)\/\/([^:/?#]*):?(\d*)/i))||r[1]===o.protocol&&r[2]===o.hostname&&r[3]===o.port||(n.crossOrigin="anonymous"),n.src=t}))}catch(t){return Promise.reject(t)}}(t)).then(function(){W(),G(),D(!1)})})}catch(t){return Promise.reject(t)}var t}():D(!0)},[n,O.current,T,H]);var V=function(t,e,o){var r=t.x,n=t.y;if(e.includes("-"))o[e]={x:r,y:n},e.includes("left")&&(o.left=s(o["left-top"],o["left-bottom"])),e.includes("right")&&(o.right=s(o["right-top"],o["right-bottom"])),e.includes("top")&&(o.top=s(o["left-top"],o["right-top"])),e.includes("bottom")&&(o.bottom=s(o["left-bottom"],o["right-bottom"]));else{var l=r-o[e].x,a=n-o[e].y;"left"===e?(o["left-top"]={x:r,y:o["left-top"].y+a},o["left-bottom"]={x:r,y:o["left-bottom"].y+a},o.left=s(o["left-top"],o["left-bottom"]),o.top=s(o["left-top"],o["right-top"]),o.bottom=s(o["left-bottom"],o["right-bottom"])):"right"===e?(o["right-top"]={x:r,y:o["right-top"].y+a},o["right-bottom"]={x:r,y:o["right-bottom"].y+a},o.right=s(o["right-top"],o["right-bottom"]),o.top=s(o["left-top"],o["right-top"]),o.bottom=s(o["left-bottom"],o["right-bottom"])):"top"===e?(o["left-top"]={x:o["left-top"].x+l,y:n},o["right-top"]={x:o["right-top"].x+l,y:n},o.top=s(o["left-top"],o["right-top"]),o.left=s(o["left-top"],o["left-bottom"]),o.right=s(o["right-top"],o["right-bottom"])):"bottom"===e&&(o["left-bottom"]={x:o["left-bottom"].x+l,y:n},o["right-bottom"]={x:o["right-bottom"].x+l,y:n},o.bottom=s(o["left-bottom"],o["right-bottom"]),o.left=s(o["left-top"],o["left-bottom"]),o.right=s(o["right-top"],o["right-bottom"]))}z(function(t){return i({},t,o)})},Y=o.useCallback(function(t,e,o){var r=t.x,n=t.y;if(q(),e.includes("-")){var i,l=null===(i=A.current)||void 0===i?void 0:i.getContext("2d",{alpha:!0,willReadFrequently:!0});if(!O.current)return;null==l||l.drawImage(O.current,r-(m-10),n-(m-10),m+5,m+5,r+10,n-90,m+20,m+20)}V(t,e,o)},[]),U=o.useCallback(function(t,e,o){var r,n=t.x,a=t.y;q(),V(t,e,o),null==l||l(i({},o,((r={})[e]={x:n,y:a},r)))},[]);return r.createElement("div",{style:i({position:"relative"},_&&d(_))},_&&"crop"===H&&I&&O.current&&r.createElement(o.Fragment,null,r.createElement(h,{pointSize:m,pointBgColor:y,pointBorder:v,cropPoints:I,previewDims:_,onDrag:Y,onStop:U,bounds:{left:O.current.offsetLeft-m/2,top:O.current.offsetTop-m/2,right:O.current.offsetLeft-m/2+O.current.offsetWidth,bottom:O.current.offsetTop-m/2+O.current.offsetHeight}}),r.createElement(f,{displayGrid:E,previewDims:_,cropPoints:I,lineWidth:g,lineColor:x,pointSize:m}),r.createElement("canvas",{style:{position:"absolute",zIndex:5,pointerEvents:"none"},width:_.width,height:_.height,ref:A})),r.createElement("canvas",{style:{zIndex:5,pointerEvents:"none"},ref:O}))},g=r.forwardRef(function(t,o){return t.image?r.createElement(e.OpenCvProvider,{openCvPath:t.openCvPath},r.createElement(m,Object.assign({},t,{cropperRef:o}))):null});module.exports=g;
//# sourceMappingURL=index.js.map
